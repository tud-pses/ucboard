
\chapter{Kommunikation}


\section{Prinzip}

Die Kommunikation mit dem ucboard ist textbasiert, so dass eine Bedienung über ein einfaches Terminalprogramm möglich ist. Dies ermöglicht ein einfaches Testen und Debuggen. Um dennoch ein einfaches Parsen der Nachrichten zu ermöglichen, besitzen diese ein definiertes Format.

In der Regel sind alle Nachrichten auch einfach lesbar. Um bezüglich der Messdatenerfassung etwas platzeffizienter zu sein, können diese jedoch optional als hex- oder base64-codierte Binärdaten versendet werden.

Ebenso wird in der Regel auf Prüfsummen verzichtet. Lediglich bei Messdaten, die als Binärdaten verschickt werden, kann optional eine CRC16-Prüfsumme angehängt werden. (Bei manchen Befehlen zum ucboard besteht die Möglichkeit, die wesentliche Zahl doppelt zu senden.)

Messdaten und Textnachrichten können vom ucboard ohne Auf"|forderung versendet werden. Ansonsten reagiert das ucboard auf Befehle, die an dieses geschickt werden. Dabei wird jeder Befehl durch eine Antwort quitiert.

\begin{itemize}
	\item Die Nachrichten zum ucboard sollen sich möglichst einfach Parsen lassen. Die Nachrichten bestehen aus einem oder mehreren, durch Leerzeichen getrennte Wörter. Der Typ eines Wortes ergibt sich aus dem ersten Zeichen:
		\begin{itemize}
			\item \texttt{A} - \texttt{Z} und \texttt{\_}: String
			\item \verb+~+: Optionsname
			\item \texttt{0} - \texttt{9} und \texttt{-}: Zahl
		\end{itemize}
	\item Besteht eine Nachricht aus mehreren Wörtern, so spielt die Anzahl der Leerzeichen zwischen den Wörtern keine Rolle. (Mindestens eines!)
\end{itemize}

Prinzipiell wird nicht zwischen Groß- und Kleinschreibung unterschieden.

Ein Nachricht beginnt mit einem Startzeichen und endet mit einem Endezeichen. Das Startzeichen kann variieren. Bei Nachrichten zum ucboard ist dieses \texttt{!} oder \texttt{?}, bei Nachrichten vom ucboard \texttt{:}, \texttt{'} und \texttt{\#}. Nach dem Startzeichen kann, muss aber kein Leerzeichen folgen. Alle Startzeichen dürfen auch innerhalb der Nachrichten verwendet werden. Dort haben sie keine besondere Bedeutung. (Eine "`Aufsynchronisierung"' sollte also anhand des Endezeichens erfolgen.)

Das Endezeichen ist \texttt{\textbackslash n} (newline) bei Nachrichten zum ucboard und \texttt{\textbackslash 03} (ETX) bei Nachrichten vom ucboard. Die Motivation dahinter ist, dass damit bei Nachrichten zum ucboard eine einfaches Terminalprogramm verwendet werden kann, bei Nachrichten vom ucboard jedoch auch mehrzeiliger Text sinnvoll dargestellt werden kann.

Einzelne Zeilenumbrüche (leere Nachrichten) sind zu ignorieren. (Diese werden optional nach ETX vom ucboard verwendet, um die Darstellung im Terminprogramm zu verbessern.)


\subsubsection{Zu ucboard}
\begin{itemize}
	\item Befehle beginnen mit \texttt{!}
	\item Abfragen beginnen mit \texttt{?}
	\item Antworten auf Fragen des ucboard (im interaktiven Modus) besitzen keinen speziellen Beginn. (Sie dürfen aber auch mit \texttt{!} oder \texttt{?} beginnen.
	\item Das Ende einer Nachricht wird ausschließlich durch \texttt{\textbackslash n} (newline) markiert
	\item Optionen beginnen mit \verb+~+. Wenn der Option ein Wert zugeordnet wird, dann wird dieser nach einem \texttt{=} angeschlossen. Dabei dürfen um das Gleichheitszeichen herum keine Leerzeichen stehen!
	\item Die Reihenfolge der Argumente spielt eine Rolle. Die Position der Optionen spielt keine Rolle. (Bei Verarbeiten im ucboard wird zunächst eine Liste der Argumente und eine Liste der Optionen erstellt. Die Information, ob eine Option am Anfang, zwischen zwei Argumenten oder am Ende stand geht dabei verloren.)
\end{itemize}


\subsubsection{Von ucboard}
\begin{itemize}
	\item Direkte Antworten beginnen mit \texttt{:}
	\item Auch jeder Schreibbefehl sollte eine kurze Antwort zur Quittierung senden, \zB \verb+:ok\n+. Es wäre empfehlenswert, den gesetzten Wert zu wiederholen
	\item Fehler bei der Abarbeitung von Befehlen beginnen mit \texttt{:ERR(code)}, wobei \texttt{code} eine positive Ganzzahl als Fehlercode ist. Optional kann nach einem weiteren Doppelpunkt eine Beschreibung des Fehlers folgen: \texttt{:ERR(code):Beschreibung} 
	\item Textausgaben (Display-Funktion) beginnen mit \texttt{'}
	\item Fehlermeldungen sind Textausgaben. Diese beginnen mit \texttt{'ERR(code)}, wobei \texttt{code} eine positive Ganzzahl als Fehlercode ist. Optional kann nach einem weiteren Doppelpunkt eine Beschreibung des Fehlers folgen: \texttt{'ERR(code):Beschreibung} 
	\item Ohne Auf"|forderung versendete Messdaten beginnen mit \texttt{\#} (base64- oder hex-codiert) \bzw \texttt{\#\#} (lesbarer Text).
	\item Wenn eine Nutzerinteraktion notwendig ist, dann sollte das letzte Zeichen vor dem Nachrichtendezeichen ein \texttt{?} oder \texttt{:} sein.
	\item Alle Nachrichten vom ucboard haben ETX (0x03) als Endzeichen. (Dadurch ist es möglich, eine mehrzeilige Ausgabe auf dem Terminalprogramm zu erzeugen.)
		\begin{itemize}
			\item Über eine -- aktuell noch fest eingestellte Option -- wird nach jedem ETX automatisch ein Zeilenumbruch geschickt. Dies dient der besseren Lesbarkeit. Es wäre jedoch besser, ein Terminalprogramm zu verwenden (\bzw zu schreiben), welches ETX durch einen Zeilenumbruch ersetzt. Damit wäre sowohl der Text besser lesbar als auch der Sparsamkeit Rechnung getragen.
			%\item Für die bessere Lesbarkeit ist es empfehlenswert, alle Textnachrichten mit einem Zeilenumbruch (vor ETX) abzuschließen. Lediglich bei hex- oder base64-basierten Messdatennachrichten wird dies nicht gemacht, da diese gerade für eine sparsame Kommunikation gedacht sind.
		\end{itemize}
\end{itemize}



\section{Hardware}

Das ucboard verfügt über zwei Schnittstellen für die Kommunikation mit dem PC. Zum einen kann über einen USB-Anschluss eine serielle Kommunikation aufgebaut werden und zum anderen kann eine RS232-Schnittstelle verwendet werden. Die RS232-Schnittstelle wird dabei nicht als Standard-D-SUB-Stecker (9-polig) angeboten, sondern als Wannensteckeranschluss. Dieser ist so belegt, dass eine direkte Verbindung zu den Anschlüssen des Onboard-PC über ein Flachbandkabel erfolgen kann.

Der dritte, "`reine"' UART-Anschluss ist für den Anschluss möglicher Erweiterungen und nicht die Kommunikation mit dem PC vorgesehen.\footnote{Man könnte auch noch darüber nachdenken, die dritte UART auch für die Kommunikation mit einem PC zu verwenden, da an dieser einfach ein Bluetooth-Adapter angeschlossen werden könnte. Damit wäre es möglich, auch ohne den Onboard-PC das Fahrzeug ferngesteuert zu betreiben.}


Die Parameter der Schnittstellen sind in \tabref{tab:Comm:UARTParam} zusammengefasst.

\begin{table}%
	\centering
	\caption{Einstellungen serielle Schnittstellen}
	\label{tab:Comm:UARTParam}
	\begin{tabular}{lcr}
			\mytoprule
			 & USB & RS232 \\
			\mymidrule
			Baudrate & 921\,600 & 115\,200 \\
			Datenbits & 8 & 8 \\
			Stopbits & 1 & 1 \\
			Parity & keine & keine \\
			Hardware-Flowcontrol & Nein & Nein \\
			\mybottomrule
	\end{tabular}\\
	\color[rgb]{1,0,0}{ToDo: Testen, welche Baudrate jeweils maximal möglich ist!} \textcolor[rgb]{0.75,0.75,0.75}{\footnotesize{Man könnte dies auch über einen Befehl einstellbar machen, und ein Rücksetzen darüber erreichen, dass beim Starten des ucboards \zB der Taster A betätigt wird. Aber das erscheint mir für diesen Zweck unnötig.}}
\end{table}


\section{Befehle}

\subsection{Übersicht}

\begin{table}[htbp]%
	\centering
	\caption{Übersicht über Hauptbefehle ucboard}
	\label{tab:Comm:Cmds}
	\begin{tabular}{ll}
		\mytoprule
		\verb|RESET| & Neustart ucboard \\
		\verb|VER| & Abfrage Softwareversion \\
		\verb|ID|	& Abfragen der Fahrzeug-ID \\
		\verb|SID| & Setzen und Abfragen der Session-ID \\
		\verb|TICS| & Abfrage ucboard-Zeit (Millisekunden nach (Neu)start) \\
		\verb|STEER| & Setzen und Abfragen des (Soll-)Lenkwinkels \\
		\verb|DRV| & Setzen und Abfragen der Fahrgeschwindigkeit \\
		\verb|DAQ| & Datenerfassung \\
		\verb|VOUT| & Ein- und Ausschalten \valunit{12}{V}-Ausgang (Kinect) \\
		\textcolor[rgb]{0.75,0.75,0.75}{\texttt{IMU}} & \textcolor[rgb]{0.75,0.75,0.75}{Zum Parametrieren der IMU} \\
		\textcolor[rgb]{0.75,0.75,0.75}{\texttt{US}} & \textcolor[rgb]{0.75,0.75,0.75}{Zum Parametrieren der US-Sensoren}\\
		\textcolor[rgb]{0.75,0.75,0.75}{\texttt{EEPROM}} & \textcolor[rgb]{0.75,0.75,0.75}{Zum Auslesen des EEPROM-Inhalts}\\
		\mybottomrule
	\end{tabular}
\end{table}



\textbf{Wichtig:} Momentan werden numerische Eingaben noch nicht an allen Stellen daraufhin überprüft, ob es tatsächlich eine (Ganz)Zahl ist. Dies bedeutet, dass \zB Eingaben wie \verb|1000.|, \verb|1000.0| oder auch \verb|+1000| für Tausend eine unerwartete Zahl ergibt.


\subsection{Beschreibung}

\subsubsection{RESET}

Führt einen Neustart des ucboards durch.


\begin{verbatim}
	!RESET NOW
\end{verbatim}



\subsubsection{VER}

Fragt Versionsstring der ucboard-Software ab.


\begin{verbatim}
	?VER
	:0.1.x
\end{verbatim}



\subsubsection{ID}

Zur Abfrage der Fahrzeug-ID, also der Nummer, die über die Dipschalter auf der Platine eingestellt wird.


\begin{verbatim}
	?ID
	:4
\end{verbatim}


\subsubsection{SID}

Zum Abfragen und Setzen der Session-ID. Dies ist einfach eine Zahl, die nach einem Neustart des ucboards auf 0 gesetzt wird, und der beliebige \verb|int32|-Werte gegeben werden können.


\begin{verbatim}
	?SID
	:0
\end{verbatim}

\begin{verbatim}
	!SID 25363
	:25363
\end{verbatim}

\begin{verbatim}
	?SID
	:25363
\end{verbatim}




\subsubsection{STEER}

Zum Setzen und Abfragen des Soll-Lenkwinkels (Servo-Vorgabe). Der Wert muss eine Ganzzahl zwischen $-1\,000$ und $1\,000$ sein.

Setzen:
\begin{verbatim}
	!STEER -200
	:-200
\end{verbatim}

{\color[rgb]{0.75,0.75,0.75} Optionale Wiederholung des Arguments, um Fehlübertragungen zu detektieren:
\begin{verbatim}
	!STEER -200 -200
	:-200
\end{verbatim}

\begin{verbatim}
	!STEER -200 -201
	:Err(269): Message corrupted! (The two values have to be equal!)
\end{verbatim}
}


Abfragen:
\begin{verbatim}
	?STEER
	:-200
\end{verbatim}



\subsubsection{DRV}

Zum Setzen und Abfragen der Fahrgeschwindigkeit. (\Bzw Motorspannung.)

Es gibt zwei Modi: Die "`gemanagte"' und die "`direkte"' Ansteuerung. Siehe dazu \secref{sec:hw:drivectrl}.


\paragraph{Gemanagte Ansteuerung}

Bei der gemanagten Ansteuerung erfolgt die Umschaltung von Vorwärts- und Rückwärtsfahrt automatisch. Zudem wird der gesetzte Wert in den Arbeitsbereich umgerechnet.

Vorwärtsfahrt:
\begin{verbatim}
	!DRV F 300
	:F 300
\end{verbatim}
Optionale Wiederholung des Arguments, um Fehlübertragungen zu detektieren:
\begin{verbatim}
	!DRV F 300 300
	:F 300
\end{verbatim}

\begin{verbatim}
	!drv f 300 301
	:Err(269): Message corrupted! (The two values have to be equal!)
\end{verbatim}


Es sind Werte von -500 bis 1000 zulässig. Dabei entsprechen negative Werte Bremsen (aber nicht einer Rückwärtsfahrt!).

Die effektive Auf"|lösung ist geringer als der Stellbereich von 1000 es annehmen lässt. Tatsächlich können etwas weniger als 450 unterscheidbare Impulsbreiten, \dah Sollwerte, vorgegeben werden.

Bremsen
\begin{verbatim}
	!DRV F -500
	:F -500
\end{verbatim}
Gebremst wird vom Fahrtenregler automatisch nur bis zum Stillstand. Es erfolgt keine Rückwärtsfahrt.


Rückwärtsfahrt
\begin{verbatim}
	!DRV B 300
	:B 300
\end{verbatim}
Es sind Werte von 0 bis 500 zulässig. (Der Stellbereich des Fahrtenreglers ist rückwärts nur halb so groß wie vorwärts.)




Ausschalten des Fahrtenreglers:
\begin{verbatim}
	!DRV OFF
	:OFF
\end{verbatim}
Der Unterschied zwischen den Werten 0 und \verb|OFF| liegt darin, dass bei \verb|OFF| der Fahrtenregler vom Fahrakku getrennt wird, also tatsächlich ausgeschaltet ist. Der Fahrtenregler wird bei Übermittlung des nächsten Sollwertes ungleich \verb|OFF| automatisch wieder eingeschaltet, jedoch dauert dies einen Moment. (Das Einschalten wird auch mit einem Piepston des Fahrtenreglers begleitet.)


Abfragen:
\begin{verbatim}
	?DRV
	:F 300
\end{verbatim}


Abfragen der tatsächlichen Impulsbreite (vergleiche "`Direkte Ansteuerung"'):
\begin{verbatim}
	?DRV D
	:D -186
\end{verbatim}


\paragraph{Direkte Ansteuerung}
Bei der direkten Ansteuerung wird direkt die Impulsbreite vorgegeben, die an den Fahrtenregler übertragen wird. Dabei wird die Impulsbreite als die Abweichung in Mikrosekunden vom Neutralwert \valunit{1,5}{ms} angegeben. \Dah ein Wert von $-500$ entspricht der minimalen Impulsbreite (\dah Maximalwert \emph{vorwärts}) von \valunit{1}{ms} und ein Wert von 500 der maximalen Impulsbreite von \valunit{2}{ms}.


\begin{verbatim}
	!DRV D 200
	:D 200
\end{verbatim}





\paragraph{DMS}

{\color[rgb]{0.75,0.75,0.75}
"`Totmannschaltung"' (Dead-man switch)\\
\\
Dieser Parameter gibt die Zeit in Millisekunden an, innerhalb derer eine neue DRV-Nachricht erhalten sein muss. Wird diese Zeit ohne DRV-Nachricht überschritten, so wird der Motor gestoppt, \dah der Sollwert auf 0 (aber nicht \texttt{OFF} gesetzt.) (Bei der nächsten \texttt{DRV}-Nachricht wird der Motor dann wieder angesteuert.)

\begin{verbatim}
	!DRV ~DMS=1000
	:ok
\end{verbatim}
\textcolor[rgb]{0.75,0.75,0.75}{
Zum Abschalten der Sicherheitsschaltung dient der Wert \texttt{OFF}.}


DRV kann auch ohne Parameter aufgerufen werden. Dann dient er nur dazu, die Zeitzählung der Totmannschaltung (\bzw Tot-PC-Schaltung) neu zu starten.

\begin{verbatim}
	!DRV
	:ok
\end{verbatim}
}


\subsubsection{DAQ}

Das Datenerfassungsmodul (DAQ -- Data Aquisition) dient als allgemeine Schnittstelle zur Übermittlung aller Sensorsignale. Dabei können Einzelabfragen vorgenommen werden (die angefragten Sensorwerte werden direkt als Antwort auf einen entsprechenden Befehl verschickt) als auch Gruppen von Sensorsignale eingerichtet werden, die dann automatisch vom ucboard an den PC geschickt werden.

Die Sensorsignale werden dabei hier als "`Kanäle"' bezeichnet. Die aktuell definierten Kanäle sind in \tabref{tab:Comm:DAQ:Signals} zusammengefasst.

\begin{table}[htbp]%
	\centering
	\caption{Signale}
	\label{tab:Comm:DAQ:Signals}
	\begin{tabular}{lp{8cm}lll}
		\mytoprule
		Signal & Beschreibung & Einheit & Datentyp & Länge \\
		\mymidrule
		\verb|AX| & Beschleunigung $x$-Richtung &  & \verb|int16_t| & 2 \\
		\verb|AY| & Beschleunigung $y$-Richtung &  & \verb|int16_t| & 2 \\
		\verb|AZ| & Beschleunigung $z$-Richtung &  & \verb|int16_t| & 2 \\
		\verb|GX| & Drehrate um $x$-Achse & & \verb|int16_t| & 2 \\
		\verb|GY| & Drehrate um $y$-Achse & & \verb|int16_t| & 2 \\
		\verb|GZ| & Drehrate um $z$-Achse & & \verb|int16_t| & 2 \\
		\verb|USF| & Abstand vorne & \valunit{0,1}{mm} & \verb|uint16_t| & 2 \\
		\verb|USL| & Abstand links & \valunit{0,1}{mm} & \verb|uint16_t| & 2 \\
		\verb|USR| & Abstand rechts & \valunit{0,1}{mm} & \verb|uint16_t| & 2 \\
		\verb|VSBAT| & Spannung Systemakku & mV & \verb|uint16_t| & 2\\
		\verb|VDBAT| & Spannung Fahrakku & mV & \verb|uint16_t| & 2\\
		\verb|HALL_DT| & Zeit zwischen den letzten beiden Impulsen des Hallsensors (eine Achtel Radumdrehung) & \valunit{0,1}{ms} & \verb|uint16_t| & 2\\
		\verb|HALL_DT8| & Zeit zwischen den letzten acht Impulsen des Hallsensors (eine Radumdrehung) & \valunit{1}{ms} & \verb|uint16_t| & 2\\
		\verb|HALL_CNT| & Anzahl der Sensorimpulse, Modulo 256 (Ein Sensorwert von "`1"' entspricht dabei immer eine ungeraden Zahl) &  & \verb|uint8_t| & 1\\
		\mybottomrule
	\end{tabular}
\end{table}


Zur Übermittlung von Fehlerwerten sind bestimmte Zahlenwerte oder Textausgaben vorgesehen, die in \tabref{tab:Comm:DAQ:SpecialValues} aufgeführt sind. Dabei ist "`keine Daten vorhanden"' ein Wert, der vom DAQ-Modul selber gesetzt werden, wenn keine gültigen Daten vorliegen. Die einzelnen Sensormodule geben im Fehlerfall entweder "`Messfehler"' (bei einzelnen Messfehlern oder Messaussetzern) oder "`Sensorfehler"' (ein größeres Sensorproblem, \dah es ist in diesem Fall mit dem Ausfall aller (weiteren) Messwerten zu rechnen) zurück.


\begin{table}[htbp]%
	\centering
	\caption{Fehlerwerte}
	\label{tab:Comm:DAQ:SpecialValues}
	\subfloat[Binärcodierung]{%
		\begin{tabular}{lcccccc}
			\mytoprule
			Datentyp & \texttt{uint32\_t} & \texttt{int32\_t} & \texttt{uint16\_t} & \texttt{int16\_t} & \texttt{uint8\_t} & \texttt{int8\_t} \\
			\mymidrule
			Keine Daten vorhanden & \texttt{0xFFFFFFFF} & \texttt{0x7FFFFFFF} & \texttt{0xFFFF} & \texttt{0x7FFF} & \texttt{0xFF} & \texttt{0x7F} \\
			Messfehler & \texttt{0xFFFFFFFE} & \texttt{0x7FFFFFFE} & \texttt{0xFFFE} & \texttt{0x7FFE} & \texttt{0xFE} & \texttt{0x7E} \\
			Sensorfehler & \texttt{0xFFFFFFFD} & \texttt{0x7FFFFFFD} & \texttt{0xFFFD} & \texttt{0x7FFD} & \texttt{0xFD} & \texttt{0x7D} \\
			Wert zu groß oder zu klein  & \texttt{0xFFFFFFFC} & \texttt{0x7FFFFFFC} & \texttt{0xFFFC} & \texttt{0x7FFC} & \texttt{0xFC} & \texttt{0x7C} \\
			Wert zu groß  & \texttt{0xFFFFFFFC} & \texttt{0x7FFFFFFC} & \texttt{0xFFFC} & \texttt{0x7FFC} & \texttt{0xFC} & \texttt{0x7C} \\
			Wert zu klein & \texttt{0xFFFFFFFB} & \texttt{0x7FFFFFFB} & \texttt{0xFFFB} & \texttt{0x7FFB} & \texttt{0xFB} & \texttt{0x7B} \\
			\mybottomrule
		\end{tabular}}\\
	\subfloat[Textausgabe]{%
		\begin{tabular}{lc}
			\mytoprule
			 & \\
			\mymidrule
			Keine Daten vorhanden & \texttt{[-{}-{}-]}  \\
			Messfehler & \texttt{[mfault]}  \\
			Sensorfehler & \texttt{[fault]} \\
			Wert zu groß oder zu klein & \texttt{[range]} \\
			Wert zu groß  & \texttt{[over]}  \\
			Wert zu klein & \texttt{[under]} \\
			\mybottomrule
		\end{tabular}}
\end{table}



\paragraph{Allgemeines}

Alle aktuell definierten Kanäle können mit \verb|?DAQ CHS| abgefragt werden:
\begin{verbatim}
	?DAQ CHS
	:14
	AX         | acc. ahead                     | opt-dep.!       | 1     | I16 
	AY         | acc. left                      | opt-dep.!       | 1     | I16 
	[...]
	HALL_DT8   | delta time full rev.           | 1 ms            | undef | U16 
\end{verbatim}
Dabei beinhalten die Spalten die folgenden Informationen
\begin{itemize}
	\item Name
	\item Beschreibung
	\item Einheit (\verb|opt-dep.!| bedeutet, dass die Einheit von den jeweiligen Sensoreinstellungen abhängt.)
	\item Abtastzeit in Millisekunden (\verb|undef| bedeutet, dass das entsprechende Sensormodul keine feste Abtastzeit der Messwerte garantiert.)
	\item Datentyp
\end{itemize}

Die Informationen zu einem speziellen Kanal können über
\begin{verbatim}
	?DAQ CH name
\end{verbatim}
abgefragt werden:
\begin{verbatim}
	?DAQ CH USF
	:USF        | ultrasonic front distance      | 0.1 mm          | undef | U16
\end{verbatim}



\paragraph{Einzelabfrage von Werten}

Zur Abfrage von Einzelwerten dient der Subbefehl \verb|GET|:
\begin{verbatim}
	!DAQ GET chname1 [chname2 [chname3 [...]]] [~AGE] [~TICS]
\end{verbatim}
Diesem muss mindestens der Name eines Kanals übergeben werden. Es können aber auch mehrere Kanäle auf einmal abgefragt werden. Die Option \verb|~AGE| gibt zu \emph{jedem} Wert das Alter in Tics (\dah ms) zwischen dem Zeitpunkt der Datenerfassung und der Datenabfrage zurück. Die Option \verb|~TICS| gibt zu \emph{jedem} Wert den Erfassungszeitpunkt in Tics zurück. Sind beide Optionen gewählt, dann wird immer AGE vor TICS zurückgegeben, unabhängig von der Reihenfolge der Optionen.

Beispiele:

Einzelabfrage des Sensorwertes des vorderen Ultraschallsensors
\begin{verbatim}
	?DAQ GET USF
	:1860
\end{verbatim}

Ausgabe des Alters des Messwertes
\begin{verbatim}
	!DAQ GET ~AGE USF
	:1860 68
\end{verbatim}

Abfrage aller Ultraschallwerte, jeweils mit Alter
\begin{verbatim}
	?DAQ GET ~AGE USL USF USR
	:487 72 | 1860 75 | 4293 85
\end{verbatim}



\begin{verbatim}
	?DAQ GET ~TICS USF
	:1860 3059246
\end{verbatim}







\paragraph{Automatische Messgruppen}

Es stehen zwanzig parametrierbare Messgruppen zur Verfügung, die zum automatischen Verschicken von Messdaten verwendet werden. In diesen können bis zu zehn verschiedene Kanäle (Sensorwerte) zusammengefasst werden. Neben den normalen Kanälen stehen noch die in \tabref{tab:Comm:DAQ:SpecialChannels} aufgeführten "`Sonderkanäle"' zur Verfügung, die Metadaten zu den Datensätzen enthalten. (Diese stehen bei der Einzelabfrage über \verb|?DAQ GET chname| nicht zur Verfügung.)

Es wird je Gruppe immer nur ein Messdatensatz gepuffert. Kann dieser nicht verschickt werden, bis die nächste Abtastung der Gruppe erfolgt ist, so wird dieser verworfen. Dabei werden alle Gruppen gleichberechtigt behandelt, \dah es erfolgt keine Bevorzugung von Messgruppen mit kleiner Abtastzeit. Damit ist die Wahrscheinlichkeit gering, dass bei langsam abgetasteten Messgruppen Daten verlorengehen, auch wenn viel Bandbreite für Messgruppen mit kleiner Abtastzeit belegt wird.\footnote{An dieser Stelle muss noch angemerkt werden, dass das Management der zu versendenden Daten im Idle-Task des ucboards erfolgt. \Dah während der Datenerfassung im SysTick-Task werden keine neuen Daten zum Verschicken bereit gemacht, auch wenn der letzte Datensatz abgearbeitet ist. Damit ist der erreichbare Datendurchsatz kleiner als der sich theoretisch aus der Baudrate ergebenden Wert. Dies kann \bzw sollte in Zukunft noch geändert werden. Bisher benötigt der SysTick-Task weniger als \valunit{200}{\upmu s}. Damit würde im ungünstigsten Fall die Datenrate ein Fünftel "`verlieren"'.}

Eine Messgruppe wird über den Subbefehl \verb|GRP| definiert.
\begin{verbatim}
	!DAQ GRP grpnb chname1 [chname2 [chname3 [...]]] [~option1] [~option2] [...]
\end{verbatim}
Die Gruppennummer \verb|grpnb| muss eine Ganzzahl zwischen 0 und 19 sein.

Die Möglichkeiten der Gruppendefinition wird zunächst an Beispielen demonstriert. Danach werden die Optionen genauer beschrieben.
\begin{itemize}
	\item Gruppe 1 enthält die Werte des Ultraschalls. Es wird gesendet, wenn alle Ultraschallwerte vorliegen, wobei maximal \valunit{10}{ms} nach dem Erfassen des ersten Wertes gewartet wird. Die Daten werden base64-codiert und mit einer CRC16-Prüfsumme verschickt.
		\begin{verbatim}
			!DAQ GRP 1 ~ALL=10 ~ENC=B64 ~CRC _TIC USL USF USR 
		\end{verbatim}
		(Die Reihenfolge der Kanalnamen (\verb|_TIC|, \verb|USL|, \verb|USF|, \verb|USR|) spielt eine Rolle, da die Messwerte ohne Namen in dieser Reihenfolge ausgegeben werden. Die Reihenfolge der Optionen und ob diese am Anfang oder Ende oder auch zwischen den Kanalnamen stehen spielt keine Rolle.)
	\item Gruppe 2 enthält die Spannungen der beiden Akkus, wobei immer eine Nachricht verschickt wird, sobald eine neue Spannung gemessen ist.
		\begin{verbatim}
			!DAQ GRP 2 ~ANY VSBAT VDBAT 
		\end{verbatim}
	\item Gruppe 3 enthält die Beschleunigungswerte in der Ebene und die Gierrate. Die Daten werden alle \valunit{10}{ms} verschickt. Dabei werden alle innerhalb der \valunit{10}{ms} erfassten Daten gemittelt.
		\begin{verbatim}
			!DAQ GRP 3 ~TS=10 ~AVG ~ENC=B64 ~CRC AX AY GZ 
		\end{verbatim}
\end{itemize}


Optionen:
\begin{itemize}
	\item Modus Abtastung
		\begin{itemize}
			\item \verb+~ALL[=maxwait]+: Sendet, wenn zu allen Gruppenkanäle neue Daten vorhanden sind. Wenn \verb+maxwait+ gegeben ist, dann wird nach dem ersten neuen Wert maximal diese Zeit in Millisekunden gewartet, bis die Daten verschickt werden.\footnote{Dies ist \zB für die US-Sensoren gedacht, deren Daten meist an nacheinander liegenden Zeitschritten ankommen.}
			\item \verb+~ANY+: Sendet, wenn zu einem der Gruppenkanäle ein neues Datum vorhanden ist.
			\item \verb+~TS=Ts+: Abtastzeit in Millisekunden. (Muss ein ganzes Vielfaches der Abtastzeiten aller Kanäle des Paketes sein.)
			\begin{itemize}
				\item \verb+~AVG[=Ta]+: Mittelung über Zeitraum \verb|Ta|. (Nur im Abtastmodus \verb|TS| verfügbar.) Wenn die Option \verb|AVG| verwendet wird, dann müssen alle Gruppenkanäle die gleiche Abtastzeit besitzen. \verb|Ta| darf dabei maximal \verb|Ts| sein und muss ein ganzes Vielfaches der Abtastzeit der Gruppenkanäle sein. Wenn kein \verb|Ta| angegeben ist, dann wird \verb|Ta| = \verb|Ts| gesetzt.\\
				Diese Mittelung kann damit bezüglich der Sensorabtastzeit $T_\mrm{s,sig}$ über die Übertragungsfunktion
				\begin{align*}
					G_\mrm{avg}(z) = \frac{\frac{1}{n_\mrm{avg}} \cdot ( z^{n_\mrm{avg}-1} + z^{n_\mrm{avg}-2} + \cdots + 1)}{z^{n_\mrm{avg}-1}}
				\end{align*}
				mit $n_\mrm{avg} = \mathtt{Ta}/T_\mrm{s,sig}$ ausgedrückt werden. Über \verb+~TS=Ts+ wird dann eine Unterabtastung mit dem Faktor $\mathtt{Ts}/T_\mrm{s,sig}$ vorgenommen.
			\end{itemize}
			
				
		\end{itemize}
	\item \verb+~SKIP=n+: Überspringt \texttt{n} Werte. \Dah bei einem Wert von neun wird jeder zehnte Wert verwendet. Dieses Überspringen wird nach allen anderen Berechnungen und Abfragen durchgeführt. Diese Option dient primär zum Debuggen (um die Menge an ausgegebenem Text zu reduzieren), kann aber auch zur Unterabtastung für Kanäle ohne feste Abtastzeit verwendet werden. (Dabei ist dann aber keine Mittelung möglich.)
	\item \verb+~ENC=B64|HEX|ASCII+: Nachricht wird base64-codiert (ohne Padding), Hex-codiert oder Ascii-codiert. ASCII meint hierbei "`lesbaren Text"'. Standardwert ist ASCII.
	\item \verb+~CRC+: CRC16-Prüfsumme (Nur wenn ENC = B64 oder HEX)\\
		Berechnung mit:
		\begin{lstlisting}[style=C_colored_smallfont]
// from Antonio Pires, http://stackoverflow.com/questions/10564491/function-to-calculate-a-crc16-checksum

// CRC-16-CCITT (polynom 0x1021)


uint16_t crc16(uint8_t* data_p, uint16_t length)
{
	uint8_t x;
	uint16_t crc = 0xFFFF;

    while (length--)
    {
        x = (crc >> 8) ^ (*data_p++);
        x ^= (x >> 4);
        crc = (crc << 8) ^ ((uint16_t)(x << 12)) ^ ((uint16_t)(x <<5)) ^ ((uint16_t)x);
    }

    return crc;
}
		\end{lstlisting}
	\item \verb+~AGE+ und \verb+~TICS+: Wie bei Einzelwertabfrage. Damit wird \emph{jedem} Wert das Alter sowie der Erfassungszeitpunkt hinzugefügt. (Wenn beide Optionen gewählt sind, dann immer in der Reihenfolge "`Age -- Tics"'.) Die Werte werden bei der Ascii-Codierung immer innerhalb der senkrechten Striche des Kanals geschrieben. Bei Binärcodierungen werden diese Werte jeweils als \valunit{32}{bit}-Werte jeweils hinter den betreffenden Messwert eingefügt. Diese Optionen dienen lediglich zum Debuggen. Im "`Normalbetrieb"' sollten diese aufgrund des großen Platzbedarfs nicht verwendet werden!\footnote{Das Alter \texttt{AGE} bezieht sich auf den Abtastzeitpunkt des Datensatzes, nicht auf den Zeitpunkt des Versendens. Der Wert ist damit nur bei der Abtastart \texttt{ALL} relevant, da dort die Daten einer Gruppe zu unterschiedlichen Zeitpunkten abgetastet sein können. Die Zeitdifferenz zwischen Abtastzeitpunkt und Versenden kann durch den Sonderkanal \texttt{\_DLY} abgefragt werden. (Somit ist das tatsächliche Alter \texttt{AGE} + \texttt{\_DLY} plus die Zeit zur Datenübermittlung und Verzögerungen innerhalb des Betriebssystem des PCs.)}
\end{itemize}


\begin{table}[htbp]%
	\centering
	\caption{"`Sonderkanäle"' mit Metadaten}
	\label{tab:Comm:DAQ:SpecialChannels}
	\begin{tabular}{lp{10cm}lll}
		\mytoprule
		Signal & Beschreibung & & Datentyp & Länge \\
		\mymidrule
		\verb|_CNT| & Anzahl der verschickten Datensätze der Gruppe &  & \verb|uint32_t| & 4 \\
		\verb|_CNT16| & die niederwertigen \valunit{16}{bits} von \verb|_CNT| &  & \verb|uint16_t| & 2 \\
		\verb|_CNT8| & die niederwertigen \valunit{8}{bits} von \verb|_CNT| &  & \verb|uint8_t| & 1 \\[2mm]
		\verb|_TICS| & ucboard-Zeit (tics) der Erfassung des ersten Datums & ms & \verb|uint32_t| & 4 \\
		\verb|_TICS16| & die niederwertigen \valunit{16}{bits} von \verb|_TIC| & ms & \verb|uint16_t| & 2 \\
		\verb|_TICS8| & die niederwertigen \valunit{8}{bits} von \verb|_TIC| & ms & \verb|uint8_t| & 1 \\[2mm]
		\verb|_DTICS| & Delta der ucboard-Zeit zwischen ersten und letztem Datum & ms & \verb|uint32_t| & 4 \\
		\verb|_DTICS16| & min\{\verb|_DTICS|, 65\,535\} & ms & \verb|uint16_t| & 2 \\
		\verb|_DTICS8| & min\{\verb|_DTICS|, 255\} & ms & \verb|uint8_t| & 1 \\[2mm]
		\verb|_DLY| & Zeit zwischen Datensatzerstellung und Versenden, bei 255 gesättigt & ms & \verb|uint8_t| & 1 \\
		\mybottomrule
	\end{tabular}
\end{table}


Weitere Funktionen zu Messgruppen:
\begin{itemize}
	\item Anzeige aller Gruppeninformationen
		\begin{verbatim}
			?DAQ GRPS
			:[...]
		\end{verbatim}
	\item Anzeigen Informationen zur Gruppe 1
		\begin{verbatim}
			?DAQ GRP 1
			:[...]
		\end{verbatim}
	\item Löschen von Gruppe 1
		\begin{verbatim}
			!DAQ GRP 1 ~DELETE
			:ok
		\end{verbatim}
	\item Deaktivieren von Gruppe 1
		\begin{verbatim}
			!DAQ GRP 1 ~DEACTIVATE
			:ok
		\end{verbatim}
	\item Aktivieren von Gruppe 1
		\begin{verbatim}
			!DAQ GRP 1 ~ACTIVATE
			:ok
		\end{verbatim}
		(Standardmäßig ist eine Gruppe nach der (Neu-)Definition aktiviert. Dies kann unterbunden werden, indem die Option \verb|~DEACTIVATE| in die Definition mit aufgenommen wird.)
\end{itemize}

Starten und Anhalten der Erfassung und Übermittlung der Messdaten
\begin{itemize}
	\item Starten der Datenerfassung
		\begin{verbatim}
			!DAQ START
			:started
		\end{verbatim}
	\item Anhalten der Datenerfassung
		\begin{verbatim}
			!DAQ STOP
			:stopped
		\end{verbatim}
	\item Abfrage Status der Datenerfassung
		\begin{verbatim}
			?DAQ
			:stopped
		\end{verbatim}
\end{itemize}

Die Neudefinition einer Gruppe erfolgt durch einfaches Überschreiben der Gruppendefinition. Dabei ist zu beachten, dass \emph{aktive} Gruppen nur dann überschrieben werden können, wenn die Datenerfassung angehalten ist (\texttt{!DAQ STOP}).


\paragraph{Binärdaten}
Bei \verb|ENC| = \verb|B64| und \verb|HEX| werden die Daten als Binärdaten verschickt.

Dabei ist das erste Byte des dekodierten Binärdatensatzes die Messgruppe. Darauf folgen ohne Leer- oder Trennzeichen die einzelnen Messdaten mit der jeweils für den Kanal gültigen Breite.


\begin{verbatim}
	!daq grp 1 usl usf usr ~all=20
	:ok
	!daq grp 2 usl usf usr ~all=20 ~enc=hex
	:ok
	!daq grp 3 usl usf usr ~all=20 ~enc=hex ~crc
	:ok
	!daq grp 4 usl usf usr ~all=20 ~enc=b64 ~crc
	:ok
	!daq start
	:started
\end{verbatim}

\begin{verbatim}
	##1:7306 | 1887 | 3655
	#028A1C5F07470E
	#038A1C5F07470ECFA5
	#BIocXwdHDou8
\end{verbatim}


\paragraph{Sonstiges}

Die Definition einer Messgruppe, die nur aus Sonderkanälen besteht, ist möglich. Dies ist jedoch -- wenn überhaupt -- nur mit der Abtastart \verb|TS| sinnvoll, da bei \verb|ANY| und \verb|ALL| nie ein Datensatz verschickt werden würde.

So kann mit
\begin{verbatim}
	!daq grp 1 _cnt8 _dly ~Ts=10 ~enc=b64
\end{verbatim}
ein "`Taktgeber"' erzeugt werden, der alle \valunit{10}{ms} einen Wert schickt. Über \verb|_CNT8| kann dabei festgestellt werden, ob Werte übersprungen wurden, und mit \verb|_DLY|, ob der aktuelle Wert verzögert wurde.



\subsubsection{VOUT}

Einschalten der Kinect-Spannung
\begin{verbatim}
	!VOUT ON
	:ON
\end{verbatim}

Abschalten der Kinect-Spannung
\begin{verbatim}
	!VOUT OFF
	:OFF
\end{verbatim}


Abfragen Zustand
\begin{verbatim}
	?VOUT
	:OFF
\end{verbatim}




%\subsubsection{IMU CAL}






